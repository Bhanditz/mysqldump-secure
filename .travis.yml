language: bash
services:
  - mysql

before_script:
  # Install 'shellcheck'
  - sudo add-apt-repository "deb http://archive.ubuntu.com/ubuntu/ trusty-backports restricted main universe"
  - sudo apt-get update -qq
  - sudo apt-get install -qq shellcheck tmpreaper

  # Add SQL data
  - mysql -uroot -e 'create database my_empty_db1;'
  - mysql -uroot -e 'create database my_empty_db2;'
  - mysql -uroot -e 'create database my_full_db1;'
  - mysql -uroot -e 'create database my_full_db2;'
  - echo "CREATE TABLE IF NOT EXISTS test (b1 LONGTEXT, b2 LONGTEXT, b3 LONGTEXT, b4 LONGTEXT, b5 LONGTEXT, b6 LONGTEXT, b7 LONGTEXT, b8 LONGTEXT, b9 LONGTEXT, ba LONGTEXT, bb LONGTEXT, bc LONGTEXT, bd LONGTEXT, be LONGTEXT, bf LONGTEXT);" > my_full_db.sql
  - for (( i=1; i < 10000; i++ )); do echo "INSERT INTO test VALUES(\"1000000000000000000000000000000000000000000000000000000000000\", \"2000000000000000000000000000000000000000000000000000000000000\", \"3000000000000000000000000000000000000000000000000000000000000\", \"4000000000000000000000000000000000000000000000000000000000000\", \"5000000000000000000000000000000000000000000000000000000000000\", \"6000000000000000000000000000000000000000000000000000000000000\", \"7000000000000000000000000000000000000000000000000000000000000\", \"8000000000000000000000000000000000000000000000000000000000000\", \"9000000000000000000000000000000000000000000000000000000000000\", \"A0000000000000000000000000000000000000000000000000000000000000\", \"B000000000000000000000000000000000000000000000000000000000000\", \"C000000000000000000000000000000000000000000000000000000000000\", \"D000000000000000000000000000000000000000000000000000000000000\", \"E0000000000000000000000000000000000000000000000000000000000000\", \"F000000000000000000000000000000000000000000000000000000000000\");" >> my_full_db.sql; done;
  - for (( i=1; i < 10; i++ )); do mysql -uroot my_full_db1 < my_full_db.sql; done
  - mysql -uroot my_full_db2 < my_full_db.sql

  # Install mysqldump-secure
  - ./configure
  - make
  - sudo make install

  # Create credentials file
  - echo '[client]' | sudo tee /etc/mysqldump-secure.cnf
  - echo 'host = localhost' | sudo tee --append /etc/mysqldump-secure.cnf
  - echo 'user = root' | sudo tee --append /etc/mysqldump-secure.cnf
  - echo 'password = ' | sudo tee --append /etc/mysqldump-secure.cnf

  # Create public key
  - echo "-----BEGIN CERTIFICATE-----" | sudo tee /etc/mysqldump-secure.pub.pem
  - echo "MIICKzCCAdWgAwIBAgIJAK8CnVnY1v8TMA0GCSqGSIb3DQEBBQUAMEUxCzAJBgNV" | sudo tee -a /etc/mysqldump-secure.pub.pem
  - echo "BAYTAkFVMRMwEQYDVQQIEwpTb21lLVN0YXRlMSEwHwYDVQQKExhJbnRlcm5ldCBX" | sudo tee -a /etc/mysqldump-secure.pub.pem
  - echo "aWRnaXRzIFB0eSBMdGQwHhcNMTYwMjE5MTI1MzQwWhcNMTYwMzIwMTI1MzQwWjBF" | sudo tee -a /etc/mysqldump-secure.pub.pem
  - echo "MQswCQYDVQQGEwJBVTETMBEGA1UECBMKU29tZS1TdGF0ZTEhMB8GA1UEChMYSW50" | sudo tee -a /etc/mysqldump-secure.pub.pem
  - echo "ZXJuZXQgV2lkZ2l0cyBQdHkgTHRkMFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAJbs" | sudo tee -a /etc/mysqldump-secure.pub.pem
  - echo "9Fl9MpFv6ANYWv1gyHwjBIOjQj1c7txI6Sl8xupeptaCXID4u+8ApVSdX6/sYzNa" | sudo tee -a /etc/mysqldump-secure.pub.pem
  - echo "P6X94ylMxe5KKLKplKkCAwEAAaOBpzCBpDAdBgNVHQ4EFgQUAsaaTBKduky2krrA" | sudo tee -a /etc/mysqldump-secure.pub.pem
  - echo "sLwKI1qjKMowdQYDVR0jBG4wbIAUAsaaTBKduky2krrAsLwKI1qjKMqhSaRHMEUx" | sudo tee -a /etc/mysqldump-secure.pub.pem
  - echo "CzAJBgNVBAYTAkFVMRMwEQYDVQQIEwpTb21lLVN0YXRlMSEwHwYDVQQKExhJbnRl" | sudo tee -a /etc/mysqldump-secure.pub.pem
  - echo "cm5ldCBXaWRnaXRzIFB0eSBMdGSCCQCvAp1Z2Nb/EzAMBgNVHRMEBTADAQH/MA0G" | sudo tee -a /etc/mysqldump-secure.pub.pem
  - echo "CSqGSIb3DQEBBQUAA0EAiOW8UkIM1aE3O5RnKm+PwoWuDr1lzYxfe0WTMeHuXpSQ" | sudo tee -a /etc/mysqldump-secure.pub.pem
  - echo "HHOCKmg8MbLpaXJulypJ1lTupqX8G5vlfYMNZldGAg==" | sudo tee -a /etc/mysqldump-secure.pub.pem
  - echo "-----END CERTIFICATE-----" | sudo tee -a /etc/mysqldump-secure.pub.pem

  # Enable encryption
  - sudo sed -i'' 's/^ENCRYPT=0/ENCRYPT=1/' /etc/mysqldump-secure.conf

  # Enable Nagios log
  - sudo sed -i'' 's/^NAGIOS_LOG=0/NAGIOS_LOG=1/' /etc/mysqldump-secure.conf

  # Enable Deletion (Delete all if older than 1 hour)
  - sudo sed -i'' 's/^DELETE=0/DELETE=1/' /etc/mysqldump-secure.conf
  - sudo sed -i'' 's/^DELETE_FORCE=0/DELETE_FORCE=1/' /etc/mysqldump-secure.conf
  - sudo sed -i'' 's/^DELETE_METHOD="tmpwatch"/DELETE_METHOD="tmpreaper"/' /etc/mysqldump-secure.conf
  - sudo sed -i'' 's/^DELETE_IF_OLDER=720/DELETE_IF_OLDER=1m/' /etc/mysqldump-secure.conf


sudo: required

script:
  # 1. [LINTING] Shellcheck
  - shellcheck --shell=sh bin/mysqldump-secure
  - shellcheck --shell=sh bin/create-keypair.sh
  - shellcheck --shell=sh bin/decrypt.sh
  - shellcheck --shell=sh bin/encrypt.sh
  - shellcheck --shell=sh --exclude=SC2034,SC2148 etc/mysqldump-secure.conf

  # 2. [TEST-MODE] mysqldump-secure
  - sudo mysqldump-secure --test

  # 3. [CRON-MODE] mysqldump-secure
  - sudo rm /var/log/mysqldump-secure.log &&
    sudo touch /var/log/mysqldump-secure.log &&
    sudo chmod 600 /var/log/mysqldump-secure.log &&
    sudo touch -a -m -t 201512180130.09 /var/mysqldump-secure/delete-me-1.txt &&
    sudo touch -a -m -t 201512180130.09 /var/mysqldump-secure/delete-me-2.txt &&
    sudo touch -a -m -t 201512180130.09 /var/mysqldump-secure/delete-me-3.txt &&
    sudo touch -a -m -t 201512180130.09 /var/mysqldump-secure/delete-me-4.txt
  - sudo mysqldump-secure --cron
  - ./nagios/check_mysqldump-secure -i24 -e -c -l -d1 -f/var/log/mysqldump-secure.nagios.log
  - sudo cat /var/log/mysqldump-secure.log

  # 3. [WARNING] [CRON-MODE] mysqldump-secure (with warnings)
  - sudo rm -rf /var/mysqldump-secure/ &&
    sudo rm /var/log/mysqldump-secure.log
  - sudo mysqldump-secure --cron

  # 4. [NORMAL] mysqldump-secure
  - sudo rm -rf /var/mysqldump-secure/ &&
    sudo mkdir -p /var/mysqldump-secure/ &&
    sudo chmod 700 /var/mysqldump-secure/ &&
    sudo touch -a -m -t 201512180130.09 /var/mysqldump-secure/delete-me-1.txt &&
    sudo touch -a -m -t 201512180130.09 /var/mysqldump-secure/delete-me-2.txt &&
    sudo touch -a -m -t 201512180130.09 /var/mysqldump-secure/delete-me-3.txt &&
    sudo touch -a -m -t 201512180130.09 /var/mysqldump-secure/delete-me-4.txt
  - sudo mysqldump-secure
  - ./nagios/check_mysqldump-secure -i24 -e -c -l -d1 -f/var/log/mysqldump-secure.nagios.log

  # 5. [ERROR] mysqldump-secure (producing an error by trying to overwrite existing files)
  - sudo mysqldump-secure || echo "---------- Error triggered successfully ----------"
  - ./nagios/check_mysqldump-secure -i24 -e -c -l -d1 -f/var/log/mysqldump-secure.nagios.log || echo "---------- Error triggered successfully ----------"

  # 6. [ERROR] mysqldump-secure (trying to delete read-only files without force)
  - sudo rm -rf /var/mysqldump-secure/ &&
    sudo mkdir -p /var/mysqldump-secure/ &&
    sudo chmod 700 /var/mysqldump-secure/ &&
    sudo touch -a -m -t 201512180130.09 /var/mysqldump-secure/delete-me-1.txt && sudo chmod 400 /var/mysqldump-secure/delete-me-1.txt &&
    sudo touch -a -m -t 201512180130.09 /var/mysqldump-secure/delete-me-2.txt && sudo chmod 400 /var/mysqldump-secure/delete-me-2.txt &&
    sudo touch -a -m -t 201512180130.09 /var/mysqldump-secure/delete-me-3.txt && sudo chmod 400 /var/mysqldump-secure/delete-me-3.txt &&
    sudo touch -a -m -t 201512180130.09 /var/mysqldump-secure/delete-me-4.txt && sudo chmod 400 /var/mysqldump-secure/delete-me-4.txt
  - sudo sed -i'' 's/DELETE_FORCE=1/DELETE_FORCE=0/' /etc/mysqldump-secure.conf
  - sudo mysqldump-secure

  # 7. [ERROR] mysqldump-secure (producing an error by not found required database)
  - sudo rm -rf /var/mysqldump-secure/
  - sudo sed -i'' 's/REQUIRE="mysql"/REQUIRE="mysql2"/' /etc/mysqldump-secure.conf
  - sudo mysqldump-secure || echo "---------- Error triggered successfully ----------"
  - ./nagios/check_mysqldump-secure -i24 -e -c -l -d1 -f/var/log/mysqldump-secure.nagios.log || echo "---------- Error triggered successfully ----------"
  - sudo sed -i'' 's/REQUIRE="mysql2"/REQUIRE="mysql"/' /etc/mysqldump-secure.conf

  # 8. [ERROR] mysqldump-secure (producing an error by config not found)
  - sudo rm -rf /var/mysqldump-secure/
  - sudo mysqldump-secure --conf /etc/mysqldump-secure.conf.notfound || echo "---------- Error triggered successfully ----------"

  # 8. [ERROR] mysqldump-secure (producing an error by running non-priviledged)
  - mysqldump-secure || echo "---------- Error triggered successfully ----------"

  # ------------ WRONG config -----------
  # 9.a [ERROR] mysqldump-secure (producing an error by wrong config)
  - sudo rm -rf /var/mysqldump-secure/
  - sudo sed -i'' 's/DUMP_DIR_CHMOD="0700"/DUMP_DIR_CHMOD="0700a"/' /etc/mysqldump-secure.conf
  - sudo mysqldump-secure && echo "---------- Complains about \$DUMP_DIR_CHMOD? ----------"
  - sudo sed -i'' 's/DUMP_DIR_CHMOD="0700a"/DUMP_DIR_CHMOD="0700"/' /etc/mysqldump-secure.conf

  # 9.b [ERROR] mysqldump-secure (producing an error by wrong config)
  - sudo rm -rf /var/mysqldump-secure/
  - sudo sed -i'' 's/DUMP_FILE_CHMOD="0700"/DUMP_FILE_CHMOD="0700a"/' /etc/mysqldump-secure.conf
  - sudo mysqldump-secure && echo "---------- Complains about \$DUMP_FILE_CHMOD? ----------"
  - sudo sed -i'' 's/DUMP_FILE_CHMOD="0700a"/DUMP_FILE_CHMOD="0700"/' /etc/mysqldump-secure.conf

  # 9.d [ERROR] mysqldump-secure (producing an error by wrong config)
  - sudo rm -rf /var/mysqldump-secure/
  - sudo sed -i'' 's/LOG="1"/LOG="2"/' /etc/mysqldump-secure.conf
  - sudo mysqldump-secure && echo "---------- Complains about \$LOG? ----------"
  - sudo sed -i'' 's/LOG="2"/LOG="1"/' /etc/mysqldump-secure.conf

  # 9.e [ERROR] mysqldump-secure (producing an error by wrong config)
  - sudo rm -rf /var/mysqldump-secure/
  - sudo sed -i'' 's/LOG_CHMOD="0600"/LOG_CHMOD="0600a"/' /etc/mysqldump-secure.conf
  - sudo mysqldump-secure && echo "---------- Complains about \$LOG_CHMOD? ----------"
  - sudo sed -i'' 's/LOG_CHMOD="0600a"/LOG_CHMOD="0600"/' /etc/mysqldump-secure.conf

  # 9.f [ERROR] mysqldump-secure (producing an error by wrong config)
  - sudo rm -rf /var/mysqldump-secure/
  - sudo sed -i'' 's/COMPRESS="1"/COMPRESS="2"/' /etc/mysqldump-secure.conf
  - sudo mysqldump-secure && echo "---------- Complains about \$COMPRESS? ----------"
  - sudo sed -i'' 's/COMPRESS="2"/COMPRESS="1"/' /etc/mysqldump-secure.conf

  # 9.g [ERROR] mysqldump-secure (producing an error by wrong config)
  - sudo rm -rf /var/mysqldump-secure/
  - sudo sed -i'' 's/COMPRESS_BIN="gzip"/COMPRESS_BIN="gzip22"/' /etc/mysqldump-secure.conf
  - sudo mysqldump-secure || echo "---------- ERROR on \$COMPRESS_BIN? ----------"
  - sudo sed -i'' 's/COMPRESS_BIN="gzip22"/COMPRESS_BIN="gzip"/' /etc/mysqldump-secure.conf

  # 9.h [ERROR] mysqldump-secure (producing an error by wrong config)
  - sudo rm -rf /var/mysqldump-secure/
  - sudo sed -i'' 's/ENCRYPT="1"/ENCRYPT="2"/' /etc/mysqldump-secure.conf
  - sudo mysqldump-secure && echo "---------- Complains about \$ENCRYPT? ----------"
  - sudo sed -i'' 's/ENCRYPT="2"/ENCRYPT="1"/' /etc/mysqldump-secure.conf

  # 9.i [ERROR] mysqldump-secure (producing an error by wrong config)
  - sudo rm -rf /var/mysqldump-secure/
  - sudo sed -i'' 's/OPENSSL_PUBKEY_PEM="${_INSTALL_PREFIX}\/etc\/mysqldump-secure.pub.pem"/OPENSSL_PUBKEY_PEM=pem/' /etc/mysqldump-secure.conf
  - sudo mysqldump-secure || echo "---------- ERROR on \$OPENSSL_PUBKEY_PEM? ----------"
  - sudo sed -i'' 's/OPENSSL_PUBKEY_PEM=pem/OPENSSL_PUBKEY_PEM="${_INSTALL_PREFIX}\/etc\/mysqldump-secure.pub.pem"/' /etc/mysqldump-secure.conf

  # 9.j [ERROR] mysqldump-secure (producing an error by wrong config)
  - sudo rm -rf /var/mysqldump-secure/
  - sudo sed -i'' 's/OPENSSL_ALGO_ARG="-aes256"/OPENSSL_ALGO_ARG="-aes2561"/' /etc/mysqldump-secure.conf
  - sudo mysqldump-secure || echo "---------- ERROR on \$OPENSSL_ALGO_ARG? ----------"
  - sudo sed -i'' 's/OPENSSL_ALGO_ARG="-aes2561"/OPENSSL_ALGO_ARG="-aes256"/' /etc/mysqldump-secure.conf

  # 9.k [ERROR] mysqldump-secure (producing an error by wrong config)
  - sudo rm -rf /var/mysqldump-secure/
  - sudo sed -i'' 's/DELETE="1"/DELETE="2"/' /etc/mysqldump-secure.conf
  - sudo mysqldump-secure && echo "---------- Complains about \$DELETE? ----------"
  - sudo sed -i'' 's/DELETE="2"/DELETE="1"/' /etc/mysqldump-secure.conf

  # 9.l [ERROR] mysqldump-secure (producing an error by wrong config)
  - sudo rm -rf /var/mysqldump-secure/
  - sudo sed -i'' 's/DELETE_METHOD="tmpreaper"/DELETE_METHOD="tmpreaper2"/' /etc/mysqldump-secure.conf
  - sudo mysqldump-secure && echo "---------- Complains about \$DELETE_METHOD? ----------"
  - sudo sed -i'' 's/DELETE_METHOD="tmpreaper2"/DELETE_METHOD="tmpreaper"/' /etc/mysqldump-secure.conf

  # 9.m [ERROR] mysqldump-secure (producing an error by wrong config)
  - sudo rm -rf /var/mysqldump-secure/
  - sudo sed -i'' 's/DELETE_FORCE="1"/DELETE_FORCE="2"/' /etc/mysqldump-secure.conf
  - sudo mysqldump-secure || echo "---------- Error triggered successfully ----------"
  - sudo sed -i'' 's/DELETE_FORCE="2"/DELETE_FORCE="1"/' /etc/mysqldump-secure.conf

  # 9.o [ERROR] mysqldump-secure (producing an error by wrong config)
  - sudo rm -rf /var/mysqldump-secure/
  - sudo sed -i'' 's/DELETE_IF_OLDER=1m/DELETE_IF_OLDER=1mm/' /etc/mysqldump-secure.conf
  - sudo mysqldump-secure && echo "---------- Complains about \$DELETE_IF_OLDER? ----------"
  - sudo sed -i'' 's/DELETE_IF_OLDER=1mm/DELETE_IF_OLDER=1m/' /etc/mysqldump-secure.conf

  # 9.p [ERROR] mysqldump-secure (producing an error by wrong config)
  - sudo rm -rf /var/mysqldump-secure/
  - sudo sed -i'' 's/NAGIOS_LOG="1"/NAGIOS_LOG="2"/' /etc/mysqldump-secure.conf
  - sudo mysqldump-secure && echo "---------- Complains about \$NAGIOS_LOG? ----------"
  - sudo sed -i'' 's/NAGIOS_LOG="2"/NAGIOS_LOG="1"/' /etc/mysqldump-secure.conf

  # 9.q [ERROR] mysqldump-secure (producing an error by wrong config)
  - sudo rm -rf /var/mysqldump-secure/
  - sudo sed -i'' 's/NAGIOS_LOG_CHMOD="0644"/NAGIOS_LOG_CHMOD="0644a"/' /etc/mysqldump-secure.conf
  - sudo mysqldump-secure && echo "---------- Complains about \$NAGIOS_LOG_CHMOD? ----------"
  - sudo sed -i'' 's/NAGIOS_LOG_CHMOD="0644a"/NAGIOS_LOG_CHMOD="0644"/' /etc/mysqldump-secure.conf

  # ------------ End of WRONG config -----------

  # 10. [ERROR] mysqldump-secure (producing an error by Wrong credentials)
  - sudo sed -i'' 's/localhost/localhost2/' /etc/mysqldump-secure.cnf
  - sudo mysqldump-secure || echo "---------- Error triggered successfully ----------"

  # 11. Show files
  - sudo ls -la /var/mysqldump-secure
