<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Mysqldump-secure by cytopia</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-dark.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/respond.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="stylesheets/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>
      <div id="header">
        <nav>
          <li class="fork"><a href="https://github.com/cytopia/mysqldump-secure">View On GitHub</a></li>
          <li class="downloads"><a href="https://github.com/cytopia/mysqldump-secure/zipball/master">ZIP</a></li>
          <li class="downloads"><a href="https://github.com/cytopia/mysqldump-secure/tarball/master">TAR</a></li>
          <li class="title">DOWNLOADS</li>
        </nav>
      </div><!-- end header -->

    <div class="wrapper">

      <section>
        <div id="title">
          <h1>Mysqldump-secure</h1>
          <p>(Encrypted) Secure mysqldump script with compression, logging and blacklisting</p>
          <hr>
          <span class="credits left">Project maintained by <a href="https://github.com/cytopia">cytopia</a></span>
          <span class="credits right">Hosted on GitHub Pages &mdash; Theme by <a href="https://twitter.com/michigangraham">mattgraham</a></span>
        </div>

        <h1>
<a id="mysqldump-secure" class="anchor" href="#mysqldump-secure" aria-hidden="true"><span class="octicon octicon-link"></span></a>mysqldump-secure</h1>

<p><a href="https://github.com/cytopia/mysqldump-secure#general-warning">General Warning</a> |
<a href="https://github.com/cytopia/mysqldump-secure#feature-overview">Feature Overview</a> |
<a href="https://github.com/cytopia/mysqldump-secure#installation">Installation</a> |
<a href="https://github.com/cytopia/mysqldump-secure#configuration">Configuration</a> |
<a href="https://github.com/cytopia/mysqldump-secure#contribution">Contribution</a> |
<a href="https://github.com/cytopia/mysqldump-secure#todo">Todo</a> |
<a href="https://github.com/cytopia/mysqldump-secure#license">License</a></p>

<p><a href="https://travis-ci.org/cytopia/mysqldump-secure"><img src="https://travis-ci.org/cytopia/mysqldump-secure.svg?branch=master" alt="Build Status"></a>
<a href="https://packagist.org/packages/cytopia/mysqldump-secure"><img src="https://poser.pugx.org/cytopia/mysqldump-secure/v/stable" alt="Latest Stable Version"></a> <a href="https://packagist.org/packages/cytopia/mysqldump-secure"><img src="https://poser.pugx.org/cytopia/mysqldump-secure/downloads" alt="Total Downloads"></a> <a href="https://packagist.org/packages/cytopia/mysqldump-secure"><img src="https://poser.pugx.org/cytopia/mysqldump-secure/v/unstable" alt="Latest Unstable Version"></a> <a href="doc/LICENSE"><img src="https://poser.pugx.org/cytopia/mysqldump-secure/license" alt="License"></a>
<a href="https://en.wikipedia.org/?title=POSIX"><img src="https://img.shields.io/badge/posix-100%25-brightgreen.svg" alt="POSIX"></a>
<a href="https://en.wikipedia.org/?title=Bourne_shell"><img src="https://img.shields.io/badge/type-%2Fbin%2Fsh-red.svg" alt="Type"></a></p>

<p>Mysqldump-secure is a POSIX compliant shell backup script for MySQL databases with strong security in mind.
It will backup every available database (which is readable by the specified user) as a separate file with the possibility to opt out via blacklisting. Dumped databases can optionally be piped directly to gzip or openssl in order to compress and/or encrypt the backup. Encryption is done before the file is written to disk to avoid possible race conditions.</p>

<p>Find the whole post at <a href="http://www.everythingcli.org/index.php/2015/06/13/secure-mysqldump-script-with-encryption-and-compression/">www.everythingcli.org</a></p>

<h5>
<a id="tested-on" class="anchor" href="#tested-on" aria-hidden="true"><span class="octicon octicon-link"></span></a>Tested on</h5>

<p><a href="https://www.freebsd.org"><img src="https://raw.githubusercontent.com/cytopia/icons/master/64x64/freebsd.png" alt="FreeBSD"></a>
<a href="https://www.redhat.com"><img src="https://raw.githubusercontent.com/cytopia/icons/master/64x64/redhat.png" alt="RedHat"></a>
<a href="https://www.centos.org"><img src="https://raw.githubusercontent.com/cytopia/icons/master/64x64/centos.png" alt="CentOS"></a>
<a href="https://www.debian.org"><img src="https://raw.githubusercontent.com/cytopia/icons/master/64x64/debian.png" alt="Debian"></a>
<a href="https://www.archlinux.org"><img src="https://raw.githubusercontent.com/cytopia/icons/master/64x64/archlinux.png" alt="ArchLinux"></a>
<a href="https://www.ubuntu.com"><img src="https://raw.githubusercontent.com/cytopia/icons/master/64x64/ubuntu.png" alt="Ubuntu"></a>
<a href="https://www.apple.com/osx"><img src="https://raw.githubusercontent.com/cytopia/icons/master/64x64/osx.png" alt="OSX"></a></p>

<h2>
<a id="general-warning" class="anchor" href="#general-warning" aria-hidden="true"><span class="octicon octicon-link"></span></a>General Warning</h2>

<p>Most mysqldump scripts I have seen out there do something like this:</p>

<div class="highlight highlight-shell"><pre>mysqldump --user=root --password=foo --host localhost database <span class="pl-k">&gt;</span> database.sql</pre></div>

<p><strong>THIS IS REALLY DANGEROUS</strong></p>

<p>Even if run inside a script, you can see the mysql password in cleartext in <code>ps aux</code>.
You should always define your credentials in a my.cnf file with <code>chmod 400</code> or you can loose all your databases to everybody with access to that machine.</p>

<blockquote>
<p><a href="https://dev.mysql.com/doc/refman/5.7/en/password-security-user.html">MySQL End-User Guidelines for Password Security</a></p>

<p>Specifying a password on the command line should be considered insecure. You can use an option file to avoid giving the password on the command line.</p>
</blockquote>

<h2>
<a id="feature-overview" class="anchor" href="#feature-overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Feature Overview</h2>

<ul>
<li>Encryption</li>
<li>Compression</li>
<li>Blacklisting</li>
<li>Tmpwatch integration</li>
<li>File logging</li>
<li>Error checking / security validation</li>
<li>Custom mysqldump options</li>
</ul>

<h2>
<a id="installation" class="anchor" href="#installation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installation</h2>

<h3>
<a id="automated-installation" class="anchor" href="#automated-installation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Automated installation</h3>

<p>Automated installation and setting of access rights via <code>unix Makefile</code>.</p>

<div class="highlight highlight-shell"><pre>sudo make install</pre></div>

<p>Adjust the configuration and you are good to go.</p>

<div class="highlight highlight-shell"><pre>vim /etc/mysqldump-secure.conf
vim /etc/mysqldump-secure.cnf</pre></div>

<h3>
<a id="manual-installation" class="anchor" href="#manual-installation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Manual installation</h3>

<p>If you do not trust the <code>Makefile</code> you can also manually copy the files and adjust file permissions by hand.</p>

<div class="highlight highlight-shell"><pre><span class="pl-c"># Copy the script</span>
cp mysqldump-secure.sh /usr/local/sbin/mysqldump-secure.sh
chmod +x /usr/local/sbin/mysqldump-secure.sh

<span class="pl-c"># Copy the config files</span>
cp mysqldump-secure.conf /etc/mysqldump-secure.conf
chmod 400 /etc/mysqldump-secure.conf

cp mysqldump-secure.cnf /etc/mysqldump-secure.cnf
chmod 400 /etc/mysqldump-secure.cnf

<span class="pl-c"># Create the backup dir</span>
mkdir -p /shared/backup/databases
chmod 700 /shared/backup/databases

<span class="pl-c"># Create the logfile (optionally)</span>
touch /var/log/mysqldump-secure.log
chmod 600 /var/log/mysqldump-secure.log
</pre></div>

<p>Adjust the configuration and you are good to go.</p>

<div class="highlight highlight-shell"><pre>vim /etc/mysqldump-secure.conf
vim /etc/mysqldump-secure.cnf</pre></div>

<h3>
<a id="cronjob" class="anchor" href="#cronjob" aria-hidden="true"><span class="octicon octicon-link"></span></a>Cronjob</h3>

<p>Once you have tested the script you can setup the cronjob:</p>

<pre><code># Dump MySQL Databases at 03:15 every day
  15 3  *  *  * /bin/sh /usr/local/sbin/mysqldump-secure.sh
</code></pre>

<h2>
<a id="configuration" class="anchor" href="#configuration" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configuration</h2>

<p>Before you start make sure to have the credentials setup correctly.</p>

<ol>
<li>Copy <a href="mysqldump-secure.cnf">mysqldump-secure.cnf</a> to <code>/etc/mysqldump-secure.cnf</code>
</li>
<li>Adjust credentials: <code>vi /etc/mysqldump-secure.cnf</code>
</li>
<li>Set permissions: <code>chmod 400 /etc/mysqldump-secure.cnf</code>
</li>
<li>Test connection: <code>mysql</code>
</li>
</ol>

<p>If you see the mysql prompt then everything went fine and you can continue configuring the program.</p>

<h3>
<a id="encryption" class="anchor" href="#encryption" aria-hidden="true"><span class="octicon octicon-link"></span></a>Encryption</h3>

<p>Encryption is done by public/private key via <a href="https://www.openssl.org/docs/apps/smime.html">OpenSSL SMIME</a> which also supports encrypting large files.</p>

<blockquote>
<p>The primary advantage of public-key cryptography is increased security and convenience: private keys never need to be transmitted or revealed to anyone. In a secret-key system, by contrast, the secret keys must be transmitted (either manually or through a communication channel) since the same key is used for encryption and decryption. A serious concern is that there may be a chance that an enemy can discover the secret key during transmission.
<a href="http://www.emc.com/emc-plus/rsa-labs/standards-initiatives/advantages-and-disadvantages.htm">[1]</a></p>
</blockquote>

<p>See <a href="examples">examples</a> for scripts to generate public/private keys, encrypt and decrypt.</p>

<h4>
<a id="create-the-keypair" class="anchor" href="#create-the-keypair" aria-hidden="true"><span class="octicon octicon-link"></span></a>Create the keypair</h4>

<p>In order to enable encryption you need a public/private keypair. If you don't know how to generate them you can use provided script: <a href="examples/create-keypair.sh">create-keypair.sh</a>.</p>

<p>Once you have the keys</p>

<ol>
<li>Move the private key away from the server to a very secure location.</li>
<li>Copy the public key to <code>/etc/mysqldump-secure.pub.pem</code>
</li>
<li><code>chmod 400 /etc/mysqldump-secure.pub.pem</code></li>
</ol>

<p>Open <a href="mysqldump-secure.conf">/etc/mysqldump-secure.conf</a> and set the following variables</p>

<div class="highlight highlight-shell"><pre>ENCRYPT=1
OPENSSL_PUBKEY_PEM=<span class="pl-s"><span class="pl-pds">"</span>/etc/mysqldump-secure.pub.pem<span class="pl-pds">"</span></span>
OPENSSL_ALGO_ARG=<span class="pl-s"><span class="pl-pds">"</span>-aes256<span class="pl-pds">"</span></span></pre></div>

<h3>
<a id="compression" class="anchor" href="#compression" aria-hidden="true"><span class="octicon octicon-link"></span></a>Compression</h3>

<p>MySQL dumps can be piped directly to <code>gzip</code> before writing to disk.</p>

<p>Open <a href="mysqldump-secure.conf">/etc/mysqldump-secure.conf</a> and set the following variables</p>

<div class="highlight highlight-shell"><pre>COMPRESS=1</pre></div>

<h3>
<a id="blacklisting" class="anchor" href="#blacklisting" aria-hidden="true"><span class="octicon octicon-link"></span></a>Blacklisting</h3>

<p>Mysqldump-secure uses opt-out instead of opt-in and will by default dump every readable database to disk. If you however want to manually ignore certain databases, such as <code>information_schema</code> or <code>performance_schema</code> you can specify them in a ignore list.</p>

<p><strong>Opt-out vs Opt-in</strong>
The disadvantage of opt-out is that you might backup a database that is not needed. On the other hand if you use opt-in you could forget a database that was actually needed to be backed up.</p>

<p>Open <a href="mysqldump-secure.conf">/etc/mysqldump-secure.conf</a> and set the following variables</p>

<div class="highlight highlight-shell"><pre>IGNORE=<span class="pl-s"><span class="pl-pds">"</span>information_schema performance_schema<span class="pl-pds">"</span></span></pre></div>

<h3>
<a id="tmpwatch-integration" class="anchor" href="#tmpwatch-integration" aria-hidden="true"><span class="octicon octicon-link"></span></a>Tmpwatch integration</h3>

<p>If you have <a href="http://linux.die.net/man/8/tmpwatch">tmpwatch</a> installed you can specify to automatically delete backups older than X hours.</p>

<p>Open <a href="mysqldump-secure.conf">/etc/mysqldump-secure.conf</a> and set the following variables</p>

<div class="highlight highlight-shell"><pre>DELETE=720 <span class="pl-c"># 720 hours</span></pre></div>

<h3>
<a id="file-logging" class="anchor" href="#file-logging" aria-hidden="true"><span class="octicon octicon-link"></span></a>File logging</h3>

<p>Mysqldump-secure includes a mechanism to log every action (debug, info, warn and error) to file. The script also follows the practise of sending proper exit codes (0 for everything went fine and &gt;0 for I had some errors).</p>

<p>Open <a href="mysqldump-secure.conf">/etc/mysqldump-secure.conf</a> and set the following variables</p>

<div class="highlight highlight-shell"><pre>LOG=1
LOGFILE=<span class="pl-s"><span class="pl-pds">"</span>/var/log/mysqldump-secure.log<span class="pl-pds">"</span></span></pre></div>

<h3>
<a id="error-checking--security-validation" class="anchor" href="#error-checking--security-validation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Error checking / security validation</h3>

<p>The script performs heavy error checking and is able to fall back to default options. Checking includes:</p>

<ul>
<li>Logfile exists</li>
<li>Logfile is writeable</li>
<li>Auto creation of logfile</li>
<li>Logging turned off automatically</li>
<li>Destination dir exists</li>
<li>Destination dir is writeable</li>
<li>Auto creation of destination dir</li>
<li>Required system binaries exist</li>
<li>MySQL credentials are valid</li>
</ul>

<h3>
<a id="custom-mysqldump-options" class="anchor" href="#custom-mysqldump-options" aria-hidden="true"><span class="octicon octicon-link"></span></a>Custom mysqldump options</h3>

<p>You can specify custom mysqldump parameters in the configuration file. The default configuration dumps databases including events, triggers and routines. The dump is done via <code>--single-transaction</code> to also take transactional tables into account. All those parameters are customizable so alter them as desired.</p>

<p>Open <a href="mysqldump-secure.conf">/etc/mysqldump-secure.conf</a> and set the following variables</p>

<div class="highlight highlight-shell"><pre>MYSQL_OPTS=<span class="pl-s"><span class="pl-pds">'</span>--events --triggers --routines --single-transaction --opt<span class="pl-pds">'</span></span></pre></div>

<p>See <a href="https://dev.mysql.com/doc/refman/5.0/en/mysqldump.html">mysqldump</a> for all possible parameters.</p>

<h2>
<a id="contribution" class="anchor" href="#contribution" aria-hidden="true"><span class="octicon octicon-link"></span></a>Contribution</h2>

<p>Contributors are welcome. See <a href="doc/CONTRIBUTING.md">contribution guidelines</a>.</p>

<p>If the script runs on an operating system productively, which is currently not yet included at the top of this document, please let me know, so I can add it for reference.</p>

<h2>
<a id="todo" class="anchor" href="#todo" aria-hidden="true"><span class="octicon octicon-link"></span></a>Todo</h2>

<p>See <a href="doc/TODO.md">Todo list</a></p>

<h2>
<a id="license" class="anchor" href="#license" aria-hidden="true"><span class="octicon octicon-link"></span></a>License</h2>

<p><a href="doc/LICENSE"><img src="https://poser.pugx.org/cytopia/mysqldump-secure/license" alt="License"></a></p>
      </section>

    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-51797082-3");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>
